
#include <string.h>

#define SCHRO_ARITH_DEFINE_INLINE
#define TRUE 1
#define FALSE 0

#include "schroarith.h"
// [bin][probability of zero]
static const int getbitlookup[256][2] = {
{294102,  92,},
{242308,  277,},
{218226,  462,},
{202363,  648,},
{190515,  836,},
{181054,  1023,},
{173179,  1212,},
{166432,  1401,},
{160531,  1591,},
{155288,  1782,},
{150569,  1974,},
{146281,  2166,},
{142350,  2360,},
{138721,  2554,},
{135352,  2748,},
{132208,  2944,},
{129261,  3140,},
{126487,  3338,},
{123867,  3536,},
{121385,  3735,},
{119027,  3934,},
{116782,  4135,},
{114639,  4337,},
{112589,  4539,},
{110624,  4742,},
{108738,  4946,},
{106925,  5151,},
{105178,  5357,},
{103494,  5564,},
{101868,  5772,},
{100297,  5980,},
{98776,  6190,},
{97303,  6400,},
{95874,  6612,},
{94487,  6824,},
{93140,  7037,},
{91830,  7251,},
{90556,  7467,},
{89315,  7683,},
{88107,  7900,},
{86928,  8119,},
{85778,  8338,},
{84655,  8558,},
{83559,  8779,},
{82487,  9002,},
{81440,  9225,},
{80415,  9450,},
{79412,  9675,},
{78430,  9902,},
{77467,  10130,},
{76524,  10359,},
{75600,  10589,},
{74693,  10820,},
{73804,  11052,},
{72931,  11285,},
{72074,  11520,},
{71232,  11756,},
{70405,  11992,},
{69592,  12231,},
{68793,  12470,},
{68007,  12710,},
{67234,  12952,},
{66474,  13195,},
{65725,  13439,},
{64989,  13685,},
{64263,  13932,},
{63549,  14180,},
{62845,  14429,},
{62152,  14680,},
{61469,  14932,},
{60795,  15186,},
{60131,  15441,},
{59476,  15697,},
{58831,  15954,},
{58194,  16213,},
{57565,  16474,},
{56945,  16736,},
{56332,  16999,},
{55728,  17264,},
{55131,  17530,},
{54542,  17798,},
{53960,  18068,},
{53385,  18339,},
{52817,  18611,},
{52256,  18885,},
{51701,  19161,},
{51153,  19438,},
{50611,  19717,},
{50075,  19998,},
{49545,  20280,},
{49022,  20564,},
{48503,  20850,},
{47991,  21137,},
{47484,  21427,},
{46983,  21718,},
{46486,  22010,},
{45995,  22305,},
{45509,  22602,},
{45028,  22900,},
{44552,  23200,},
{44080,  23502,},
{43614,  23807,},
{43151,  24113,},
{42694,  24421,},
{42240,  24731,},
{41791,  25043,},
{41347,  25358,},
{40906,  25674,},
{40470,  25993,},
{40037,  26313,},
{39608,  26636,},
{39184,  26961,},
{38763,  27289,},
{38346,  27618,},
{37932,  27950,},
{37522,  28285,},
{37116,  28621,},
{36713,  28961,},
{36313,  29302,},
{35917,  29646,},
{35524,  29993,},
{35134,  30342,},
{34748,  30694,},
{34365,  31049,},
{33985,  31406,},
{33607,  31766,},
{33233,  32128,},
{32862,  32494,},
{32494,  32862,},
{32128,  33233,},
{31766,  33607,},
{31406,  33985,},
{31049,  34365,},
{30694,  34748,},
{30342,  35134,},
{29993,  35524,},
{29646,  35917,},
{29302,  36313,},
{28961,  36713,},
{28621,  37116,},
{28285,  37522,},
{27950,  37932,},
{27618,  38346,},
{27289,  38763,},
{26961,  39184,},
{26636,  39608,},
{26313,  40037,},
{25993,  40470,},
{25674,  40906,},
{25358,  41347,},
{25043,  41791,},
{24731,  42240,},
{24421,  42694,},
{24113,  43151,},
{23807,  43614,},
{23502,  44080,},
{23200,  44552,},
{22900,  45028,},
{22602,  45509,},
{22305,  45995,},
{22010,  46486,},
{21718,  46983,},
{21427,  47484,},
{21137,  47991,},
{20850,  48503,},
{20564,  49022,},
{20280,  49545,},
{19998,  50075,},
{19717,  50611,},
{19438,  51153,},
{19161,  51701,},
{18885,  52256,},
{18611,  52817,},
{18339,  53385,},
{18068,  53960,},
{17798,  54542,},
{17530,  55131,},
{17264,  55728,},
{16999,  56332,},
{16736,  56945,},
{16474,  57565,},
{16213,  58194,},
{15954,  58831,},
{15697,  59476,},
{15441,  60131,},
{15186,  60795,},
{14932,  61469,},
{14680,  62152,},
{14429,  62845,},
{14180,  63549,},
{13932,  64263,},
{13685,  64989,},
{13439,  65725,},
{13195,  66474,},
{12952,  67234,},
{12710,  68007,},
{12470,  68793,},
{12231,  69592,},
{11992,  70405,},
{11756,  71232,},
{11520,  72074,},
{11285,  72931,},
{11052,  73804,},
{10820,  74693,},
{10589,  75600,},
{10359,  76524,},
{10130,  77467,},
{9902,  78430,},
{9675,  79412,},
{9450,  80415,},
{9225,  81440,},
{9002,  82487,},
{8779,  83559,},
{8558,  84655,},
{8338,  85778,},
{8119,  86928,},
{7900,  88107,},
{7683,  89315,},
{7467,  90556,},
{7251,  91830,},
{7037,  93140,},
{6824,  94487,},
{6612,  95874,},
{6400,  97303,},
{6190,  98776,},
{5980,  100297,},
{5772,  101868,},
{5564,  103494,},
{5357,  105178,},
{5151,  106925,},
{4946,  108738,},
{4742,  110624,},
{4539,  112589,},
{4337,  114639,},
{4135,  116782,},
{3934,  119027,},
{3735,  121385,},
{3536,  123867,},
{3338,  126487,},
{3140,  129261,},
{2944,  132208,},
{2748,  135352,},
{2554,  138721,},
{2360,  142350,},
{2166,  146281,},
{1974,  150569,},
{1782,  155288,},
{1591,  160531,},
{1401,  166432,},
{1212,  173179,},
{1023,  181054,},
{836,  190515,},
{648,  202363,},
{462,  218226,},
{277,  242308,},
{92,  294102,},
};

static const uint16_t lut[256] = {
  //LUT corresponds to window = 16 @ p0=0.5 & 256 @ p=1.0
     0,    2,    5,    8,   11,   15,   20,   24,
    29,   35,   41,   47,   53,   60,   67,   74,
    82,   89,   97,  106,  114,  123,  132,  141,
   150,  160,  170,  180,  190,  201,  211,  222,
   233,  244,  256,  267,  279,  291,  303,  315,
   327,  340,  353,  366,  379,  392,  405,  419,
   433,  447,  461,  475,  489,  504,  518,  533,
   548,  563,  578,  593,  609,  624,  640,  656,
   672,  688,  705,  721,  738,  754,  771,  788,
   805,  822,  840,  857,  875,  892,  910,  928,
   946,  964,  983, 1001, 1020, 1038, 1057, 1076,
  1095, 1114, 1133, 1153, 1172, 1192, 1211, 1231,
  1251, 1271, 1291, 1311, 1332, 1352, 1373, 1393,
  1414, 1435, 1456, 1477, 1498, 1520, 1541, 1562,
  1584, 1606, 1628, 1649, 1671, 1694, 1716, 1738,
  1760, 1783, 1806, 1828, 1851, 1874, 1897, 1920,
  1935, 1942, 1949, 1955, 1961, 1968, 1974, 1980,
  1985, 1991, 1996, 2001, 2006, 2011, 2016, 2021,
  2025, 2029, 2033, 2037, 2040, 2044, 2047, 2050,
  2053, 2056, 2058, 2061, 2063, 2065, 2066, 2068,
  2069, 2070, 2071, 2072, 2072, 2072, 2072, 2072,
  2072, 2071, 2070, 2069, 2068, 2066, 2065, 2063,
  2060, 2058, 2055, 2052, 2049, 2045, 2042, 2038,
  2033, 2029, 2024, 2019, 2013, 2008, 2002, 1996,
  1989, 1982, 1975, 1968, 1960, 1952, 1943, 1934,
  1925, 1916, 1906, 1896, 1885, 1874, 1863, 1851,
  1839, 1827, 1814, 1800, 1786, 1772, 1757, 1742,
  1727, 1710, 1694, 1676, 1659, 1640, 1622, 1602,
  1582, 1561, 1540, 1518, 1495, 1471, 1447, 1422,
  1396, 1369, 1341, 1312, 1282, 1251, 1219, 1186,
  1151, 1114, 1077, 1037,  995,  952,  906,  857,
   805,  750,  690,  625,  553,  471,  376,  255
};

/* This is a copy of the above lookup-table, with the
   elements interleaved in a way that decreases the number
   of operations during decode. */
static const int16_t lut_interleaved[512] = {
    255,     0,   376,    -2,   471,    -5,   553,    -8,
    625,   -11,   690,   -15,   750,   -20,   805,   -24,
    857,   -29,   906,   -35,   952,   -41,   995,   -47,
   1037,   -53,  1077,   -60,  1114,   -67,  1151,   -74,
   1186,   -82,  1219,   -89,  1251,   -97,  1282,  -106,
   1312,  -114,  1341,  -123,  1369,  -132,  1396,  -141,
   1422,  -150,  1447,  -160,  1471,  -170,  1495,  -180,
   1518,  -190,  1540,  -201,  1561,  -211,  1582,  -222,
   1602,  -233,  1622,  -244,  1640,  -256,  1659,  -267,
   1676,  -279,  1694,  -291,  1710,  -303,  1727,  -315,
   1742,  -327,  1757,  -340,  1772,  -353,  1786,  -366,
   1800,  -379,  1814,  -392,  1827,  -405,  1839,  -419,
   1851,  -433,  1863,  -447,  1874,  -461,  1885,  -475,
   1896,  -489,  1906,  -504,  1916,  -518,  1925,  -533,
   1934,  -548,  1943,  -563,  1952,  -578,  1960,  -593,
   1968,  -609,  1975,  -624,  1982,  -640,  1989,  -656,
   1996,  -672,  2002,  -688,  2008,  -705,  2013,  -721,
   2019,  -738,  2024,  -754,  2029,  -771,  2033,  -788,
   2038,  -805,  2042,  -822,  2045,  -840,  2049,  -857,
   2052,  -875,  2055,  -892,  2058,  -910,  2060,  -928,
   2063,  -946,  2065,  -964,  2066,  -983,  2068, -1001,
   2069, -1020,  2070, -1038,  2071, -1057,  2072, -1076,
   2072, -1095,  2072, -1114,  2072, -1133,  2072, -1153,
   2072, -1172,  2071, -1192,  2070, -1211,  2069, -1231,
   2068, -1251,  2066, -1271,  2065, -1291,  2063, -1311,
   2061, -1332,  2058, -1352,  2056, -1373,  2053, -1393,
   2050, -1414,  2047, -1435,  2044, -1456,  2040, -1477,
   2037, -1498,  2033, -1520,  2029, -1541,  2025, -1562,
   2021, -1584,  2016, -1606,  2011, -1628,  2006, -1649,
   2001, -1671,  1996, -1694,  1991, -1716,  1985, -1738,
   1980, -1760,  1974, -1783,  1968, -1806,  1961, -1828,
   1955, -1851,  1949, -1874,  1942, -1897,  1935, -1920,
   1920, -1935,  1897, -1942,  1874, -1949,  1851, -1955,
   1828, -1961,  1806, -1968,  1783, -1974,  1760, -1980,
   1738, -1985,  1716, -1991,  1694, -1996,  1671, -2001,
   1649, -2006,  1628, -2011,  1606, -2016,  1584, -2021,
   1562, -2025,  1541, -2029,  1520, -2033,  1498, -2037,
   1477, -2040,  1456, -2044,  1435, -2047,  1414, -2050,
   1393, -2053,  1373, -2056,  1352, -2058,  1332, -2061,
   1311, -2063,  1291, -2065,  1271, -2066,  1251, -2068,
   1231, -2069,  1211, -2070,  1192, -2071,  1172, -2072,
   1153, -2072,  1133, -2072,  1114, -2072,  1095, -2072,
   1076, -2072,  1057, -2071,  1038, -2070,  1020, -2069,
   1001, -2068,   983, -2066,   964, -2065,   946, -2063,
    928, -2060,   910, -2058,   892, -2055,   875, -2052,
    857, -2049,   840, -2045,   822, -2042,   805, -2038,
    788, -2033,   771, -2029,   754, -2024,   738, -2019,
    721, -2013,   705, -2008,   688, -2002,   672, -1996,
    656, -1989,   640, -1982,   624, -1975,   609, -1968,
    593, -1960,   578, -1952,   563, -1943,   548, -1934,
    533, -1925,   518, -1916,   504, -1906,   489, -1896,
    475, -1885,   461, -1874,   447, -1863,   433, -1851,
    419, -1839,   405, -1827,   392, -1814,   379, -1800,
    366, -1786,   353, -1772,   340, -1757,   327, -1742,
    315, -1727,   303, -1710,   291, -1694,   279, -1676,
    267, -1659,   256, -1640,   244, -1622,   233, -1602,
    222, -1582,   211, -1561,   201, -1540,   190, -1518,
    180, -1495,   170, -1471,   160, -1447,   150, -1422,
    141, -1396,   132, -1369,   123, -1341,   114, -1312,
    106, -1282,    97, -1251,    89, -1219,    82, -1186,
     74, -1151,    67, -1114,    60, -1077,    53, -1037,
     47,  -995,    41,  -952,    35,  -906,    29,  -857,
     24,  -805,    20,  -750,    15,  -690,    11,  -625,
      8,  -553,     5,  -471,     2,  -376,     0,  -255
};

void
schro_arith_decode_init (SchroArith * arith, SchroRdFn read_fn, void * read_fn_priv)
{
  int size;

  memset (arith, 0, sizeof (SchroArith));
  arith->range[0] = 0;
  arith->range[1] = 0x7fff0000;
  arith->range_size = arith->range[1] - arith->range[0];
  arith->code = 0;
  arith->cntr = 1;

  arith->read = read_fn;
  arith->io_priv = read_fn_priv;

  arith->code = arith->read(arith->io_priv) << 24;
  arith->code |= arith->read(arith->io_priv) << 16;

  memcpy (arith->lut, (void *) lut_interleaved, 512 * sizeof (int16_t));
}

void
schro_arith_encode_init (SchroArith * arith, SchroWrFn write_fn, void * write_fn_priv)
{
  int i;

  memset (arith, 0, sizeof (SchroArith));
  arith->range[0] = 0;
  arith->range[1] = 0x7fff;
  arith->range_size = arith->range[1] - arith->range[0];
  arith->code = 0;
  arith->first_byte = 1;

  arith->write = write_fn;
  arith->io_priv = write_fn_priv;

  for (i = 0; i < 256; i++) {
    arith->lut[i] = lut[i];
    arith->lut[511 - i] = lut[255 - i];
    arith->getbitlookup[i][0] = getbitlookup[i][0];
    arith->getbitlookup[i][1] = getbitlookup[i][1];
  }
}

void
schro_arith_decode_flush (SchroArith * arith)
{
  // perform an extra renormalisation to match encoding
  while (arith->range[1] <= 0x40000000) {
    if (!--arith->cntr) {
      arith->read(arith->io_priv);
      arith->cntr = 8;
    }

    arith->range[1] <<= 1;
  }
}

void
schro_arith_flush (SchroArith * arith)
{
  int extra_byte;
  int i;

  if (arith->cntr > 0) {
    extra_byte = TRUE;
  } else {
    extra_byte = FALSE;
  }

  for (i = 0; i < 16; i++) {
    if ((arith->range[0] | ((1 << (i + 1)) - 1)) > arith->range[1] - 1)
      break;
  }
  arith->range[0] |= ((1 << i) - 1);
//arith->range[0] += arith->range[1] - 1;

  while (arith->cntr < 8) {
    arith->range[0] <<= 1;
    arith->range[0] |= 1;
    arith->cntr++;
  }

  if (arith->range[0] >= (1 << 24)) {
    arith->output_byte++;
    if (!arith->first_byte)
      arith->write(arith->output_byte, arith->io_priv);
    while (arith->carry) {
      arith->write(0x00, arith->io_priv);
      arith->carry--;
    }
  } else {
    if (!arith->first_byte)
      arith->write(arith->output_byte, arith->io_priv);
    while (arith->carry) {
      arith->write(0xff, arith->io_priv);
      arith->carry--;
    }
  }

  arith->write(arith->range[0] >> 16, arith->io_priv);
  arith->write(arith->range[0] >> 8, arith->io_priv);
  if (extra_byte)
    arith->write(arith->range[0], arith->io_priv);
}

/* wrappers */

int
schro_arith_encode_getbit(SchroArith * arith, uint16_t *probability, int value)
{
  return  _schro_arith_encode_getbit(arith, probability, value);
}

void
schro_arith_encode_bit (SchroArith * arith, uint16_t *probability, int value)
{
  _schro_arith_encode_bit (arith, probability, value);
}

int
schro_arith_decode_bit (SchroArith * arith, uint16_t *probability)
{
  return _schro_arith_decode_bit (arith, probability);
}

void
schro_arith_encode_bypass_bit(SchroArith * arith, int value)
{
  _schro_arith_encode_bypass_bit(arith, value);
}

int
schro_arith_decode_bypass_bit(SchroArith * arith)
{
  return _schro_arith_decode_bypass_bit(arith);
}
